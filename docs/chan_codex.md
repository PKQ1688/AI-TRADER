# chan_codex

## 1. 用途与边界

- 用途：作为 AI 的结构化交易分析规则，不作为主观叙事文本。
- 目标：基于价格结构识别买卖点与风险状态，输出可执行结论。
- 边界：不做点位预测，只做结构分类与条件触发判断。

## 2. 输入规范（AI必须满足）

- 至少提供两个级别K线：`主级别`、`次级别`。
- K线需含：`open/high/low/close/time`。
- 可选辅助：`MACD(12,26,9)`。
- 若数据不足以完成“分型-笔-线段-中枢”链路，输出`数据不足`，不强判。

## 3. 统一术语（标准定义）

- 分型：顶分型/底分型，先做包含关系处理后再识别。
- 笔：相邻顶底构成的有效方向段，满足最小K线规范。
- 线段：至少三笔，且前三笔有重叠。
- 走势中枢：至少三个连续次级别走势类型重叠区间。
- 走势类型：上涨、下跌、盘整。
- 背驰：同向两段比较，后段力度弱于前段。
- 盘整背驰：盘整区间内同类段比较，后段力度弱于前段。

## 4. 总流程（AI执行顺序）

1. 对K线做包含关系合并。
2. 识别分型，生成笔。
3. 由笔生成线段，标注线段方向。
4. 在主级别确认最近中枢区间`[ZD, ZG]`与当前走势类型。
5. 在次级别判断是否存在背驰/盘整背驰。
6. 按三类买卖点规则给出信号。
7. 输出操作建议与失效条件，不输出主观情绪描述。

## 5. 三类买卖点模板（定义 -> 识别 -> 入场 -> 出场 -> 常见错判）

### 5.1 第一类买卖点

- 定义：
  - 第一类买点：下跌趋势中，向下离开最后中枢后出现背驰点。
  - 第一类卖点：上涨趋势中，向上离开最后中枢后出现背驰点。
- 识别：
  - 必须先有趋势结构（至少两个同向中枢）。
  - 比较离开段力度，后段弱于前段才成立。
- 入场：
  - 买点成立后可分批试仓，优先在次级别确认转强时执行。
- 出场：
  - 若次级别反抽失败并形成反向确认，先减仓。
  - 若主级别转为不利结构，执行退出。
- 常见错判：
  - 在盘整中误把普通回落当第一类买点。
  - 只看MACD柱体，不核对中枢与级别关系。

### 5.2 第二类买卖点

- 定义：
  - 第一类买点后的次级别回抽结束点（不破关键低点）为第二类买点。
  - 第一类卖点后的次级别反抽结束点（不破关键高点）为第二类卖点。
- 识别：
  - 必须以第一类买卖点为前提，不可独立虚构。
  - 回抽结束后出现方向恢复信号。
- 入场：
  - 二买/二卖可作为主执行点，适合“确认后执行”风格。
- 出场：
  - 若回抽破坏前提关键位，视为二买/二卖失效，立即降风险。
- 常见错判：
  - 未确认“第一类成立”就提前标二类。
  - 把任意反弹/回调都当二类点。

### 5.3 第三类买卖点

- 定义：
  - 向上离开中枢后回抽，不回中枢，形成第三类买点。
  - 向下离开中枢后回抽，不回中枢，形成第三类卖点。
- 识别：
  - 强调“第一次有效回抽”。
  - 回抽终点与中枢边界关系必须明确。
- 入场：
  - 第三类买点可用于趋势跟随加仓或新开仓。
- 出场：
  - 若后续无法延续趋势并转入更大级别震荡，执行减仓。
- 常见错判：
  - 将中枢震荡内普通波动误判为第三类买卖点。
  - 忽略“第一次”条件，重复回抽也判三类。

## 6. 背驰模块（定义 -> 识别 -> 入场 -> 出场 -> 常见错判）

- 定义：
  - 背驰是力度衰减，不等价于“马上反转”。
- 识别：
  - 必须在同向结构中比较，不可跨结构乱比。
  - 先结构后指标；MACD仅做辅助证据。
- 入场：
  - 背驰仅提供转折候选，需结合中枢位置与次级别确认。
- 出场：
  - 若背驰后仅形成小级别回拉且主级别未坏，不应过度交易。
- 常见错判：
  - 看到背驰就满仓反向。
  - 忽略背驰级别，低级别信号对抗高级别趋势。

## 7. 区间套模块（定义 -> 识别 -> 入场 -> 出场 -> 常见错判）

- 定义：
  - 从高一级背驰段向低级别逐层细分，收敛出转折定位区间。
- 识别：
  - 上级别给方向，下级别给执行点。
- 入场：
  - 在收敛末端出现低级别转强信号时执行。
- 出场：
  - 若收敛失败并破坏上级别前提，退出等待下一次收敛。
- 常见错判：
  - 只看最低级别局部形态，脱离上级别结构。
  - 区间未收敛完成就提前重仓。

## 8. 级别冲突处理规则（必须执行）

- 高级别优先于低级别。
- 主级别与次级别冲突时：
  - 主级别为趋势延续，低级别逆向信号仅用于减仓/短差，不用于重仓反转。
  - 主级别临界转折，低级别确认信号可提升执行权重。
- 不允许“看小做大”或“看大做小”随意切换标准。

## 9. 风控规则（AI必须输出）

- 每个信号都要给出：
  - 触发条件
  - 失效条件
  - 对应级别
- 禁止输出：
  - 情绪化判断（如“应该会大涨”）
  - 无条件结论（如“必涨必跌”）
- 默认策略：
  - 非买卖点区域：`持有/观察`
  - 结构失效：`减仓/退出`

## 10. 标准输出格式（建议）

```json
{
  "timeframe_main": "30m",
  "timeframe_sub": "5m",
  "market_state": {
    "trend_type": "up|down|range",
    "last_zhongshu": {"zd": 0, "zg": 0}
  },
  "signals": [
    {
      "type": "B1|B2|B3|S1|S2|S3",
      "level": "main|sub",
      "trigger": "触发条件",
      "invalid_if": "失效条件",
      "confidence": 0.0
    }
  ],
  "action": {
    "decision": "buy|sell|reduce|hold|wait",
    "reason": "结构化理由"
  },
  "risk": {
    "conflict_level": "none|low|high",
    "notes": "级别冲突与风控说明"
  }
}
```

## 11. 最小执行清单（AI出结论前自检）

- 是否完成包含关系处理。
- 是否确认最近中枢边界。
- 是否明确当前主级别走势类型。
- 买卖点是否属于三类之一。
- 是否给出触发与失效条件。
